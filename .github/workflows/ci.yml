name: CI

on:
   push:
      branches: [main]
   pull_request:
      branches: [main]

jobs:
   test-and-coverage:
      runs-on: ubuntu-latest
      steps:
         - name: Checkout repository
           uses: actions/checkout@v4

         - name: Set up Dart
           uses: dart-lang/setup-dart@v1
           with:
              sdk: stable

         - name: Install dependencies
           run: dart pub get

         - name: Activate coverage tool
           run: dart pub global activate coverage

         - name: Run tests with coverage
           run: dart test --coverage=coverage

         - name: Generate lcov report
           run: |
              dart pub global run coverage:format_coverage \
                --lcov \
                --in=coverage \
                --out=coverage/lcov.info \
                --packages=.dart_tool/package_config.json \
                --report-on=lib

         - name: Upload coverage to Codecov
           uses: codecov/codecov-action@v4
           env:
              CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
           with:
              file: coverage/lcov.info
              fail_ci_if_error: false
