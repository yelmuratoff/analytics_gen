name: Lint & Analysis

on:
   push:
      branches: [main]
   pull_request:
      branches: [main]

jobs:
   analyze:
      name: Analyze (matrix Dart versions)
      runs-on: ubuntu-latest
      strategy:
         matrix:
            sdk: [stable, beta, dev]

      steps:
         - name: Checkout repository
           uses: actions/checkout@v4

         - name: Set up Dart ${{ matrix.sdk }}
           uses: dart-lang/setup-dart@v1
           with:
              sdk: ${{ matrix.sdk }}

         - name: Cache pub dependencies
           uses: actions/cache@v4
           with:
              path: ~/.pub-cache
              key: ${{ runner.os }}-pub-${{ matrix.sdk }}-${{ hashFiles('**/pubspec.lock') }}
              restore-keys: |
                 ${{ runner.os }}-pub-${{ matrix.sdk }}-
                 ${{ runner.os }}-pub-

         - name: Get dependencies
           run: |
              if [ -f example/pubspec.yaml ]; then
                mv example/pubspec.yaml example/pubspec.yaml.bak
              fi
              dart pub get
              if [ -f example/pubspec.yaml.bak ]; then
                mv example/pubspec.yaml.bak example/pubspec.yaml
              fi

         - name: Run static analyzer
           run: dart analyze

         - name: Run tests (no coverage) to validate for SDK ${{ matrix.sdk }}
           run: dart test --platform vm
